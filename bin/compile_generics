#!/usr/bin/env bash

MULTI=${MULTI:-false}

PROJ_DIR=${PROJ_DIR:-$HOME/code/CS4500/project}
OUTPUT_DIR=$PROJ_DIR/generated_code
INCLUDE_HEADER_FILE=$OUTPUT_DIR/generated_code_header.h

if ! ensure_deps; then
  exit $?
fi

GENERICS=$(cat << TYPES
list Int int
list StringPtr String*
list Float float
list Bool bool
list Char char
list IntPtr int*
list StringPtrPtr String**
list FloatPtr float*
list BoolPtr bool*
list ColumnPtr Column*
list IpV4Addr IpV4Addr
block_list Int int
block_list StringPtr String*
block_list Float float
block_list Bool bool
list_packer Int int
list_packer StringPtr String*
list_packer Float float
list_packer Bool bool
queue Int int
TYPES
)

get_sed () {
  if which gsed >/dev/null; then
    echo "gsed"
  else
    echo "sed"
  fi
}

IFS='
'
for line in $GENERICS; do
  template=$(echo "$line" | awk '{ print $1 }')
  name=$(echo "$line" | awk '{ print $2 }')
  T=$(echo "$line" | awk '{ $1 = $2 = ""; print $0 }' | $(get_sed) -E "s/(^[[:space:]]*)|([[:space:]]*$)//g")

  generate $template $name $T && echo "$template $name $T DONE" &
done

wait
